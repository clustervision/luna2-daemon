{% autoescape None %}
{% set ns = namespace(subnet_id=1) %}
#
# DHCP Server Configuration file.
# created by Luna
#

{
  "Dhcp4": {
    "authoritative": true,

    "ddns-send-updates": true,
    "ddns-override-client-update": true,
    "ddns-override-no-update": true,
    "dhcp-ddns": {
      "enable-updates": true,
      "server-ip": "127.0.0.1",
      "server-port": 53001
    },

    "interfaces-config": {
    #    "interfaces": [ "ens224" ], 
        "dhcp-socket-type": "raw"
    },

    "lease-database": {
        "type": "memfile",
        "persist": true,
        "name": "kea-leases4.csv",
        "lfc-interval": 1800,
        "max-row-errors": 100
    },

    "option-def": [
      {
        "name": "luna-id",
        "code": 129,
        "space": "dhcp4",
        "type": "string"
      }
    ],

    "subnet4": [
{%- for SHARE in SHARED -%}
    {%- for SUBNET in SHARED[SHARE] %}
      {
        "id": {{ ns.subnet_id }},
        {%- set ns.subnet_id = ns.subnet_id + 1 %}
        "subnet": "{{ SHARED[SHARE][SUBNET]['network'] }}/{{ SHARED[SHARE][SUBNET]['prefix'] }}",
        "valid-lifetime": 28800,
        {%- if SUBNET in POOLS %}
        "client-classes": ["{{ POOLS[SUBNET]['members']|first }}-class"],
        {%- elif SHARE in POOLS and SUBNET not in POOLS %}
        "client-classes": ["ipxe-{{ SUBNET }}-class", "arch-x86", "arch-arm", "arch-openpower"],
        {%- endif %}

        "pools": [
          {
        {%- if SUBNET in POOLS %}
            "pool": "{{ POOLS[SUBNET]['range_begin'] }}-{{ POOLS[SUBNET]['range_end'] }}"
        {%- elif SHARE in POOLS and SUBNET not in POOLS %}
            "pool": "{{ POOLS[SHARE]['range_begin'] }}-{{ POOLS[SHARE]['range_end'] }}"
        {%- endif %}
          }
        ],

        {%- if SUBNET in RESERVATIONS and RESERVATIONS[SUBNET] | length > 0 %}
        "reservations": [
            {%- for HOST in RESERVATIONS[SUBNET] %}
          {
            "hw-address": "{{ HOST['macaddress'] }}",
            "ip-address": "{{ HOST['ipaddress'] }}",
            "hostname": "{{ HOST['name'] }}"
                {%- if loop.last %}
          }
                {%- else %}
          },
                {%- endif -%}
            {%- endfor %}
        ],
        {%- endif -%}
        {%- if SUBNET in ZONES %}
        "ddns-qualifying-suffix": "{{ ZONES[SUBNET]['domain'] }}.",
        {%- endif -%}
        {%- if SHARED[SHARE][SUBNET]['nextserver'] is defined %}
        "next-server": "{{ SHARED[SHARE][SUBNET]['nextserver'] }}",
        {%- endif %}
        "option-data": [
        {%- if SHARED[SHARE][SUBNET]['nextserver'] is defined %}
	  { "name": "tftp-server-name", "data": "{{ SHARED[SHARE][SUBNET]['nextserver'] }}" },
        {%- endif -%}
        {%- if SHARED[SHARE][SUBNET]['nameserver_ip'] %}
          { "name": "domain-name-servers", "data": "{{ SHARED[SHARE][SUBNET]['nameserver_ip'] }}" },
        {%- endif -%}
        {%- if SHARED[SHARE][SUBNET]['ntp_server'] %}
          { "name": "ntp-servers", "data": "{{ SHARED[SHARE][SUBNET]['ntp_server'] }}" },
        {%- endif -%}
        {%- if SHARED[SHARE][SUBNET]['gateway'] is defined %}
          { "name": "routers", "data": "{{ SHARED[SHARE][SUBNET]['gateway'] }}" },
        {%- endif -%}
        {%- if SHARED[SHARE][SUBNET]['domain'] is defined %}
          { "name": "domain-name", "data": "{{ SHARED[SHARE][SUBNET]['domain'] }}" },
        {%- endif %}
          { "name": "luna-id", "data": "lunaclient" }
        ]
      },
    {%- endfor -%}
{%- endfor -%}

{% for SUBNET in SUBNETS %}
      {
        "id": {{ ns.subnet_id }},
        {%- set ns.subnet_id = ns.subnet_id + 1 %}
        "subnet": "{{ SUBNETS[SUBNET]['network'] }}/{{ SUBNETS[SUBNET]['prefix'] }}",
        "valid-lifetime": 28800,

        "pools": [
          {
	        "pool": "{{ SUBNETS[SUBNET]['range_begin'] }}-{{ SUBNETS[SUBNET]['range_end'] }}"
	  }
        ],
    {%- if SUBNET in RESERVATIONS and RESERVATIONS[SUBNET] | length > 0 %}
        "reservations": [
        {% for HOST in RESERVATIONS[SUBNET] %}
          {
            "hw-address": "{{ RESERVATIONS[SUBNET][HOST]['macaddress'] }}",
            "ip-address": "{{ RESERVATIONS[SUBNET][HOST]['ipaddress'] }}",
            "hostname": "{{ HOST }}"
          {%- if loop.last %}
          }
          {%- else %}
          },
          {%- endif -%}
        {%- endfor %}
        ],
    {%- endif -%}
    {%- if SUBNET in ZONES %}
        "ddns-qualifying-suffix": "{{ ZONES[SUBNET]['domain'] }}.",
    {%- endif -%}
    {%- if SUBNETS[SUBNET]['nextserver'] is defined %}
        "next-server": "{{ SUBNETS[SUBNET]['nextserver'] }}",
    {%- endif %}
        "option-data": [
    {%- if SUBNETS[SUBNET]['nextserver'] is defined %}
	  { "name": "tftp-server-name", "data": "{{ SUBNETS[SUBNET]['nextserver'] }}" },
    {%- endif -%}
    {%- if SUBNETS[SUBNET]['nameserver_ip'] %}
          { "name": "domain-name-servers", "data": "{{ SUBNETS[SUBNET]['nameserver_ip'] }}" },
    {%- endif -%}
    {%- if SUBNETS[SUBNET]['ntp_server'] %}
          { "name": "ntp-servers", "data": "{{ SUBNETS[SUBNET]['ntp_server'] }}" },
    {%- endif -%}
    {%- if SUBNETS[SUBNET]['gateway'] is defined %}
          { "name": "routers", "data": "{{ SUBNETS[SUBNET]['gateway'] }}" },
    {%- endif -%}
    {%- if SUBNETS[SUBNET]['domain'] is defined %}
          { "name": "domain-name", "data": "{{ SUBNETS[SUBNET]['domain'] }}" },
    {%- endif %}
          { "name": "luna-id", "data": "lunaclient" }
        ]
        #  { "name": "dhcp-server-identifier", "data": "10.141.255.254" },
    {%- if loop.last %}
      }
    {%- else %}
      },
    {%- endif %}
{%- endfor %}
    ],

    "client-classes": [
{%- for CLASS in CLASSES %}
      {
        "name": "{{ CLASSES[CLASS]['network'] }}-class",
        "test": "substring(option[vendor-class-identifier].text, 0, 5) == 'udhcp'"
      },
{%- endfor -%}
{%- for SHARE in SHARED -%}
    {%- for SUBNET in SHARED[SHARE] -%}
        {%- if SHARED[SHARE][SUBNET]['nextserver'] is defined %}
      {
        "name": "ipxe-{{ SHARE }}",
        "test": "option[77].hex == 'iPXE'",
        "boot-file-name": "http://{{ SHARED[SHARE][SUBNET]['nextserver'] }}:{{ SHARED[SHARE][SUBNET]['nextport'] }}/boot"
      },
        {%- endif -%}
    {%- endfor -%}
{%- endfor -%}
{%- for SUBNET in SUBNETS -%}
    {%- if SUBNETS[SUBNET]['nextserver'] is defined %}
      {
        "name": "ipxe-{{ SUBNET }}",
        "test": "option[77].hex == 'iPXE'",
        "boot-file-name": "http://{{ SUBNETS[SUBNET]['nextserver'] }}:{{ SUBNETS[SUBNET]['nextport'] }}/boot"
      },
    {%- endif -%}
{%- endfor %}
      {
        "name": "arch-x86",
        "test": "option[93].hex == 0x0007",
        "server-hostname": "gio4-dev-ctrl001",
        "boot-file-name": "luna_ipxe.efi"
      },
      {
        "name": "arch-arm64",
        "test": "option[93].hex == 0x000b",
        "boot-file-name": "luna_ipxe_arm64.efi"
      },
      {
        # petit boot. we do nothing for openpower
        "name": "arch-openpower",
        "test": "option[93].hex == '0x000e'"
      },
      {
        "name": "default",
        "boot-file-name": "luna_undionly.kpxe"
      }
    ]
  }
}

{% endautoescape  %}
