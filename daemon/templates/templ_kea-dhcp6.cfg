{% autoescape None %}
{% set ns = namespace(subnet_id=1) %}
#
# DHCP Server Configuration file.
# created by Luna
#

{
  "Dhcp6": {
    "ddns-send-updates": true,
    "ddns-override-client-update": true,
    "ddns-override-no-update": true,
    "dhcp-ddns": {
      "enable-updates": true,
      "server-ip": "127.0.0.1",
      "server-port": 53001
    },

    #"interfaces-config": {
    #    "interfaces": [ "ens224" ], 
    #},

    "lease-database": {
        "type": "memfile",
        "persist": true,
        "name": "kea-leases6.csv",
        "lfc-interval": 1800,
        "max-row-errors": 100
    },

    "option-def": [
      {
        "name": "luna-id",
        "code": 129,
        "space": "dhcp6",
        "type": "string"
      }
    ],

    "subnet6": [
{%- for SHARE in SHARED -%}
    {%- for SUBNET in SHARED[SHARE] %}
      {
        "id": {{ ns.subnet_id }},
        {%- set ns.subnet_id = ns.subnet_id + 1 %}
        "subnet": "{{ SHARED[SHARE][SUBNET]['network'] }}/{{ SHARED[SHARE][SUBNET]['prefix'] }}",
        "valid-lifetime": 28800,
        {%- if SUBNET in POOLS %}
        "client-classes": ["{{ POOLS[SUBNET]['members']|first }}-class"],
        {%- elif SHARE in POOLS and SUBNET not in POOLS %}
        "client-classes": ["ipxe-{{ SHARE }}", "arch-x86-{{ SHARE }}", "arch-arm-{{ SHARE }}", "arch-openpower"],
        {%- endif %}

        "pools": [
          {
        {%- if SUBNET in POOLS %}
            "pool": "{{ POOLS[SUBNET]['range_begin'] }}-{{ POOLS[SUBNET]['range_end'] }}"
        {%- elif SHARE in POOLS and SUBNET not in POOLS %}
            "pool": "{{ POOLS[SHARE]['range_begin'] }}-{{ POOLS[SHARE]['range_end'] }}"
        {%- endif %}
          }
        ],

        {%- if SUBNET in RESERVATIONS and RESERVATIONS[SUBNET] | length > 0 %}
        "reservations": [
            {%- for HOST in RESERVATIONS[SUBNET] %}
          {
            "hw-address": "{{ HOST['macaddress'] }}",
            "ip-address": "{{ HOST['ipaddress'] }}",
            "hostname": "{{ HOST['name'] }}"
                {%- if loop.last %}
          }
                {%- else %}
          },
                {%- endif -%}
            {%- endfor %}
        ],
        {%- endif -%}
        {%- if SUBNET in ZONES %}
        "ddns-qualifying-suffix": "{{ ZONES[SUBNET]['domain'] }}.",
        {%- endif %}
        "option-data": [
        {%- if SHARED[SHARE][SUBNET]['nameserver_ip_ipv6'] %}
          { "name": "dns-servers", "csv-format": true, "data": "{{ SHARED[SHARE][SUBNET]['nameserver_ip_ipv6'] }}" },
        {%- endif -%}
        {%- if SHARED[SHARE][SUBNET]['ntp_server'] and ':' in SHARED[SHARE][SUBNET]['ntp_server'] %}
          { "name": "ntp-server", "csv-format": true, "data": "{{ SHARED[SHARE][SUBNET]['ntp_server'] }}" },
        {%- endif -%}
        {%- if SHARED[SHARE][SUBNET]['domain'] is defined %}
          { "name": "domain-search", "csv-format": true, "data": "{{ SHARED[SHARE][SUBNET]['domain'] }}" },
        {%- endif %}
          { "name": "luna-id", "data": "lunaclient" }
        ]
      },
    {%- endfor -%}
{%- endfor -%}

{% for SUBNET in SUBNETS %}
      {
        "id": {{ ns.subnet_id }},
        {%- set ns.subnet_id = ns.subnet_id + 1 %}
        "subnet": "{{ SUBNETS[SUBNET]['network'] }}/{{ SUBNETS[SUBNET]['prefix'] }}",
        "valid-lifetime": 28800,
        "client-classes": ["ipxe-{{ SUBNET }}", "arch-x86-{{ SUBNET }}", "arch-arm-{{ SUBNET }}", "arch-openpower"],

        "pools": [
          {
	        "pool": "{{ SUBNETS[SUBNET]['range_begin'] }}-{{ SUBNETS[SUBNET]['range_end'] }}"
	  }
        ],
    {%- if SUBNET in RESERVATIONS and RESERVATIONS[SUBNET] | length > 0 %}
        "reservations": [
        {%- for HOST in RESERVATIONS[SUBNET] %}
          {
            "hw-address": "{{ HOST['macaddress'] }}",
            "ip-addresses": ["{{ HOST['ipaddress'] }}"],
            "hostname": "{{ HOST['name'] }}"
          {%- if loop.last %}
          }
          {%- else %}
          },
          {%- endif -%}
        {%- endfor %}
        ],
    {%- endif -%}
    {%- if SUBNET in ZONES %}
        "ddns-qualifying-suffix": "{{ ZONES[SUBNET]['domain'] }}.",
    {%- endif %}
        "option-data": [
    {%- if SUBNETS[SUBNET]['nameserver_ip_ipv6'] %}
          { "name": "dns-servers", "csv-format": true, "data": "{{ SUBNETS[SUBNET]['nameserver_ip_ipv6'] }}" },
    {%- endif -%}
    {%- if SUBNETS[SUBNET]['ntp_server'] and ':' in SUBNETS[SUBNET]['ntp_server'] %}
          { "name": "ntp-server", "csv-format": true, "data": "{{ SUBNETS[SUBNET]['ntp_server'] }}" },
    {%- endif -%}
    {%- if SUBNETS[SUBNET]['domain'] is defined %}
          { "name": "domain-search", "csv-format": true, "data": "{{ SUBNETS[SUBNET]['domain'] }}" },
    {%- endif %}
          { "name": "luna-id", "data": "lunaclient" }
        ]
    {%- if loop.last %}
      }
    {%- else %}
      },
    {%- endif %}
{%- endfor %}
    ],

    "client-classes": [
{%- for CLASS in CLASSES %}
      {
        "name": "{{ CLASSES[CLASS]['network'] }}-class",
        "test": "substring(option[vendor-class-identifier].text, 0, 5) == 'udhcp'"
      },
{%- endfor -%}

{%- for SHARE in SHARED -%}
    {%- for SUBNET in SHARED[SHARE] -%}
        {%- if SHARED[SHARE][SUBNET]['nextserver'] is defined %}
      {
        "name": "ipxe-{{ SHARE }}",
        "test": "substring(option[15].hex,2,4) == 'iPXE'",
        "option-data": [
          {
            "name": "bootfile-url",
            "code": 59,
            "data": "http://{{ SUBNETS[SUBNET]['nextserver'] }}:{{ SUBNETS[SUBNET]['nextport'] }}/boot"
          }
        ]
      },
        {%- endif -%}
    {%- endfor -%}
{%- endfor -%}

{%- for SUBNET in SUBNETS -%}
    {%- if SUBNETS[SUBNET]['nextserver'] is defined %}
      {
        "name": "ipxe-{{ SUBNET }}",
        "test": "substring(option[15].hex,2,4) == 'iPXE'",
        "option-data": [
          {
            "name": "bootfile-url",
            "code": 59,
            "data": "http://{{ SUBNETS[SUBNET]['nextserver'] }}:{{ SUBNETS[SUBNET]['nextport'] }}/boot"
          }
        ]
      },
    {%- endif -%}
{%- endfor -%}

{%- for SHARE in SHARED -%}
    {%- for SUBNET in SHARED[SHARE] -%}
        {%- if SHARED[SHARE][SUBNET]['nextserver'] is defined %}
      {
        "name": "arch-x86-{{ SHARE }}",
        "test": "option[61].hex == 0x0007",
        "only-in-additional-list": true,
        "option-data": [
          {
            "name": "bootfile-url",
            "code": 59,
            "data": "tftp://{{ SUBNETS[SUBNET]['nextserver'] }}/luna_ipxe.efi"
          }
        ]
      },
      {
        "name": "arch-arm64-{{ SHARE }}",
        "test": "option[61].hex == 0x000b",
        "only-in-additional-list": true,
        "option-data": [
          {
            "name": "bootfile-url",
            "code": 59,
            "data": "tftp://{{ SUBNETS[SUBNET]['nextserver'] }}/luna_ipxe_arm64.efi"
          }
        ]
      },
        {%- endif -%}
    {%- endfor -%}
{%- endfor -%}

{%- for SUBNET in SUBNETS -%}
    {%- if SUBNETS[SUBNET]['nextserver'] is defined %}
      {
        "name": "arch-x86-{{ SUBNET }}",
        "test": "option[61].hex == 0x0007",
        "only-in-additional-list": true,
        "option-data": [
          {
            "name": "bootfile-url",
            "code": 59,
            "data": "tftp://{{ SUBNETS[SUBNET]['nextserver'] }}/luna_ipxe.efi"
          }
        ]
      },
      {
        "name": "arch-arm64-{{ SUBNET }}",
        "test": "option[61].hex == 0x000b",
        "only-in-additional-list": true,
        "option-data": [
          {
            "name": "bootfile-url",
            "code": 59,
            "data": "tftp://{{ SUBNETS[SUBNET]['nextserver'] }}/luna_ipxe_arm64.efi"
          }
        ]
      },
    {%- endif -%}
{%- endfor %}
      {
        # petit boot. we do nothing for openpower
        "name": "arch-openpower",
        "only-in-additional-list": true,
        "test": "option[93].hex == '0x000e'"
      }
    ]
  }
}

{% endautoescape  %}
